<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <title>Using C code and the Simics API</title>
  <style>@import url(style.css);</style>
</head>

<body class="jdocu_main">
<script type="text/javascript">
parent.frames['toc'].d.openTo(14, true);
</script>
<a name="label17"></a><p class="jdocu_navbarp"><span class="jdocu_navbar"><a class="jdocu" href="topic10.html">Previous</a> - <a class="jdocu" href="main.html">Up</a> - <a class="jdocu" href="topic12.html">Next</a></span></p>
<h2 class="jdocu">3&nbsp;&nbsp;&nbsp;Using C code and the Simics API</h2 class="jdocu">


<p>
Since data types and method bodies in DML are written in an extended
subset of C, you can easily call C functions from DML by using normal
function call syntax, as in <tt>f(x)</tt> (rather than using the
<tt>call</tt> or <tt>inline</tt> keywords to call DML methods). For
example, the following is a legal DML program, based on the example in
Section <a class="jdocu" href="topic6.html#label10">2.1</a>:
<pre class="jdocu_small" style="color: black">
    dml 1.0;
    device simple_device;
    import "io-memory.dml";

    extern int fib(int x);

    bank b {
        parameter function = 0;
        register r0 size 4 @0x0000 {
            parameter allocate = false;
            method write(val) {
                log "info": "Fibonacci(%d) = %d.", val, fib(val);
            }
        }
    }

    header %{
    int fib(int x);
    %}

    footer %{
    int fib(int x) {
        if (x &lt; 2) return 1;
        else return fib(x-1) + fib(x-2);
    }
    %}
</pre>
<p>
Writing to the (pseudo-) register <tt>r0</tt> has the effect of printing
a log message with the computed Fibonacci number:
<pre class="jdocu_small" style="color: black">
  simics&gt; <b>phys_mem.set 0x1000 6</b>
  [dev1 info] Fibonacci(6) = 13.
</pre>
<p>
Notable points are:
<ul>
  <li>The C identifier <tt>fib</tt> is declared in DML using a top-level
      <tt>extern</tt> declaration.</li>
<p>
  <li>The section <tt>footer %{ ... %}</tt> is appended as it is to the
      C program generated by the DML compiler (<tt>dmlc</tt>). Its
      contents are not examined in any way by <tt>dmlc</tt>.</li>
<p>
  <li>Similarly, the <tt>header %{ ... %}</tt> section is included
      verbatim at the beginning of the program generated by
      <tt>dmlc</tt>.</li>
<p>
  <li>It is normally better to place C functions in separately compiled
      files, if possible, and link with the generated DML code. (To do
      this, you need to modify the Makefile for the module.)</li>
<p>
  <li>The function declaration must be included in the header section
      as well as being declared <tt>extern</tt> in DML. They are
      usually identical, but not always (in DML 1.0), and thus the C
      declaration is not automatically generated by <tt>dmlc</tt>; this
      could change in future releases.</li>
<p>
  <li>Header and footer sections could become deprecated or removed in
      future versions of DML.</li>
</ul>
<p>
The Simics API (a set of C functions and data types) is defined in DML
in the library file <tt>simics-api.dml</tt>, which is automatically
included by <tt>dmlc</tt>. The corresponding C declarations are defined
in header files which are also automatically included by the generated
code for a device. Hence, the DML programmer has direct access to the
entire Simics API.
<p>
For example, this is how the method <b><i>set_read_value()</i></b> is
implemented in the standard library. It updates a
<tt>generic_transaction_t</tt> structure (a "memop") at the end of a
read access to a memory bank has finished, depending on the endianism of
the bank:
<pre class="jdocu_small" style="color: black">
    method set_read_value(generic_transaction_t *memop,
                          uint64 value) default
    {
        if (!defined $byte_order)
            error
        else if ($byte_order == "little-endian")
            SIM_set_mem_op_value_le(memop, value);
        else
            SIM_set_mem_op_value_be(memop, value);
    }
</pre>
<p>
<p class="jdocu_navbarp"><span class="jdocu_navbar"><a class="jdocu" href="topic10.html">Previous</a> - <a class="jdocu" href="main.html">Up</a> - <a class="jdocu" href="topic12.html">Next</a></span></p>
</body>
</html>
